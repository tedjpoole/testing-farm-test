summary: "build-and-test-release"

prepare:
  - name: packages
    how: install
    package: [ docker ]
  - name: services
    how: shell
    script: systemctl start docker

execute:
    how: tmt
    script: |
        set -x # echo commands
        set +e # ignore errors
        mkdir -p ~/.ssh && chmod 700 ~/.ssh
        echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDj+b5VFTiq5jooZOF9fkV2jBwgwFKCL5524AsLKqxgQzbsMVu8jWWXG8SivN+0M9UnTDFqp3WNf/tlq3FwTMfLeG/TFsICSfUqnp3fAWqiELDHMIVdWBay5MGd0pLCCr2osVgGvV0XlP1B6QoU7lCGgthQ7l8ib8qcIt7ZEZ5fdzsrIfdN9LgM+w6GS/upsM/ypt13X8Qe2aIjnt2u2Ufx4PfeMdz+Xn8oIEYV4Rza9WcyNreZtHIIprmdCUHw4JtE8cbFUEx6scNyyAklT/wDJCmP93eiD1SHDVHKKpLlmew7Eb86TB06T33ahY3kNFCDYgHWN5UiRlrhuaI4P5bf ejp@black" >> ~/.ssh/authorized_keys
        chmod 644 ~/.ssh/authorized_keys
        ip a
        ls -Z /tmp
        useradd envoyuser -G docker
        pwd
        sudo -i -u envoyuser pwd
        sudo -i -u envoyuser mkdir /tmp/envoy-docker-build
        sudo -i -u envoyuser touch /tmp/envoy-docker-build/x
        sudo -i -u envoyuser rm /tmp/envoy-docker-build/x
        sudo -i -u envoyuser ENVOY_DOCKER_BUILD_DIR=/tmp/envoy-docker-build "$(pwd)/openssl/run_envoy_docker.sh" ./ci/do_ci.sh release || true
        echo SLEEPING
        sleep 1000000000

